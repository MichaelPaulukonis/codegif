<!DOCTYPE html>
<html lang="en">
<head>
	<title>codegif</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Write code, make animated gif.">
	<meta name="keywords" content="gif,html5,javascript">
	<meta name="author" content="Stefan Hedman">
	<meta name="twitter:card" content="Write code, make animated gif." />
	<meta name="twitter:creator" content="@schteppe" />
	<meta property="og:url" content="https://schteppe.github.io/codegif/" />
	<meta property="og:title" content="codegif" />
	<meta property="og:description" content="Write code, make animated gif." />
	<link rel="icon" type="image/png" href="codegif-icon-150.png" />
	<style>
		#cheatSheet {
			height: 400px;
			overflow: scroll;
		}
	</style>
	<link href="css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<script class="sample" data-name="Circle">function draw(t){

	// This is your draw function
	// The parameter "t" is the current time, a number between 0 and 1

	// You can use the HTML5 canvas API directly like this:
	beginPath();
	fillStyle = "blue";
	arc(0.5,0.5,max(0,0.1+0.1*(1+sin(2*PI*t))),0,PI*2,true);
	fill();

	// Note that all Math properties are global too, so you can use "PI" instead of "Math.PI"

	// When you're done, click "Download GIF" in the upper right corner.

	// Check out the samples (top left) if you want some inspiration!
}</script>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">codegif</a>
        </div>
        <div id="navbar" class="navbar-collapse">
          <ul class="nav navbar-nav">
            <!--<li class="active"><a href="#">Editor</a></li>-->
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Samples <span class="caret"></span></a>
              <ul class="dropdown-menu" id="samples-list">
                <!--<li><a href="#">Circle</a></li>
                <li><a href="#">Heart</a></li>
                <li><a href="#">Something else here</a></li>
                <li role="separator" class="divider"></li>
                <li class="dropdown-header">Nav header</li>
                <li><a href="#">Separated link</a></li>
                <li><a href="#">One more separated link</a></li>-->
              </ul>
            </li>
            <li><a href="#about" data-toggle="modal" data-target="#myModal">About</a></li>
          </ul>
		  <div class="navbar-form navbar-right">
			<button id="downloadButton" type="submit" class="btn btn-primary">Download GIF <span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span></button>
          </div>
        </div>
      </div>
    </nav>

	<!-- About Modal -->
	<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
		<div class="modal-header">
			<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
			<h4 class="modal-title" id="myModalLabel">About</h4>
		</div>
		<div class="modal-body">
			<p>codegif was made by <a href="https://twitter.com/schteppe">@schteppe</a>. It's Open Source under the MIT license and available on <a href="https://github.com/schteppe/codegif">Github</a>.</p>

			<p>Technologies used:</p>
			<ul>
				<li><a href="https://github.com/Microsoft/monaco-editor">Monaco editor</a></li>
				<li><a href="https://github.com/antimatter15/jsgif">jsgif</a></li>
				<li><a href="https://getbootstrap.com">Twitter Bootstrap</a></li>
			</ul>
		</div>
		<div class="modal-footer">
			<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
		</div>
		</div>
	</div>
	</div>

	<div class="container-fluid">
		<div class="row">
			<div class="col-md-3 col-sm-3 col-xs-3">
				<canvas id="bitmap" width="150" height="150" style="width:100%"></canvas>

<script class="sample" data-name="Heart" type="x-sample">function draw(t){
	translate(0.5,0.5);
	var s = (2+sin(2*PI*t))*0.4;
	scale(s,s);
	beginPath();
	fillStyle = "red";

	scale(1/150, 1/150);
	translate(-75,-75);
	moveTo(75, 40);
	bezierCurveTo(75, 37, 70, 25, 50, 25);
	bezierCurveTo(20, 25, 20, 62.5, 20, 62.5);
	bezierCurveTo(20, 80, 40, 102, 75, 120);
	bezierCurveTo(110, 102, 130, 80, 130, 62.5);
	bezierCurveTo(130, 62.5, 130, 25, 100, 25);
	bezierCurveTo(85, 25, 75, 37, 75, 40);

	fill();

	fillStyle='white';
	textAlign='center';
	font='20px sans-serif';
	fillText('MOM',75,75);
}</script>

<script class="sample" data-name="Rectangles" type="x-sample">function draw(t){
	fillStyle='rgba(0,0,0,0.75)';
	var N=5;
	var s=1/N;
	for(var i=0; i<N; i++){
		for(var j=0; j<N; j++){
			save();
			beginPath();
			translate((i+0.5)*s,(j+0.5)*s);
			rotate(PI*t/2);
			rect(-s/2,-s/2,s,s);
			fill();
			restore();
		}
	}
}</script>

<script class="sample" data-name="Image" type="x-sample">function draw(t){
	translate(0.5,0.5);
	rotate(t*PI*2);
	scale(0.5,0.5);
	var im = new Image();
	// Data URL as image. Can be created using e.g. http://dataurl.net/#dataurlmaker
	im.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAIAAAD8GO2jAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wkBDQsyuesaVgAAAB1pVFh0Q29tbWVudAAAAAAAQ3JlYXRlZCB3aXRoIEdJTVBkLmUHAAAAQElEQVRIx2Nk4PnPgBf8v8eIJsKoREALMmBioDEYtWDUglELRi0gAjD+fzUaRKMWUJqKRqvMUQtGLRi1YCRYAAA1Ego9VinEZgAAAABJRU5ErkJggg==";
	drawImage(im,-0.5,-0.5,1,1);
}</script>

<script class="sample" data-name="Elastic Bezier" type="x-sample">function draw(t){
	var w=1,h=1;
	beginPath();
	moveTo(0, h/2);
	bezierCurveTo(
		w/2 * 1.2,  h/2 * 1.2 + sin(6*PI*t) * 0.2,
		w/2,  h/2 + cos(6*PI*t) * 0.2,
		w, h/2);
	lineWidth = 0.1;
	lineCap = 'round';
	stroke();
}</script>

	<div id="cheatSheet">
		<h3>Cheat sheet</h3>
		<ul class="list-unstyled">
			<li>save()</li>
			<li>restore()</li>

			<li>scale(x,y)</li>
			<li>rotate(angle)</li>
			<li>translate(x,y)</li>
			<li>transform(m11,m12,m21,m22,dx,dy)</li>
			<li>setTransform(m11,m12,m21,m22,dx,dy)</li>

			<li>globalAlpha=1.0</li>
			<li>globalCompositeOperation='source-over'</li>

			<li>lineWidth=1.0</li>
			<li>lineCap='butt'</li>
			<li>lineJoin='miter'</li>
			<li>miterLimit=10</li>

			<li>strokeStyle='black'</li>
			<li>fillStyle='black'</li>
			<li>shadowOffsetX=0.0</li>
			<li>shadowOffsetY=0.0</li>
			<li>shadowBlur=0.0</li>
			<li>shadowColor='transparent black'</li>

			<li>g=createLinearGradient(x0,y0,x1,y1)</li>
			<li>g=createRadialGradient(x0,y0,r0,x1,y1,r1)</li>
			<li>p=createPattern(image,repetition)</li>

			<li>addColorStop(offset, color)</li>

			<li>beginPath()</li>
			<li>closePath()</li>
			<li>fill()</li>
			<li>stroke()</li>
			<li>clip()</li>
			<li>moveTo(x, y)</li>
			<li>lineTo(x, y)</li>
			<li>quadraticCurveTo(cpx, cpy, x, y)</li>
			<li>bezierCurveTo(cp1x, cp1y, cp2x, cp2y, x, y)</li>
			<li>arcTo(x1, y1, x2, y2, radius)</li>
			<li>arc(x, y, radius, startAngle, endAngle, anticlockwise)</li>
			<li>rect(x, y, w, h)</li>
			<li>b = isPointInPath(x, y)</li>

			<li>clearRect(x, y, w, h)</li>
			<li>fillRect(x, y, w, h)</li>
			<li>strokeRect(x, y, w, h)</li>

			<li>font='10px sans-serif'</li>
			<li>textAlign='start'</li>
			<li>textBaseline='alphabetic'</li>

			<li>fillText(text, x, y, [maxWidth])</li>
			<li>strokeText(text, x, y, [maxWidth])</li>
			<li>m = measureText(text)</li>
		</ul>
	</div>

			</div>
			<div class="col-md-9 col-sm-9 col-xs-9">
				<div class="container-fluid">
					<div class="row">
						<form class="form-inline">
							<div class="form-group form-group-sm">
								<div class="input-group" style="width:130px">
									<div class="input-group-addon">Frames</div>
									<input type="number" min="1" class="form-control" id="frameCount" value="60">
								</div>
							</div>
							<div class="form-group form-group-sm">
								<div class="input-group" style="width:120px">
									<div class="input-group-addon">Delay</div>
									<input type="number" min="1"  class="form-control" id="delay" value="16">
								</div>
							</div>
							<div class="form-group form-group-sm">
								<div class="input-group" style="width:125px">
									<div class="input-group-addon">Width</div>
									<input type="number" min="10"  class="form-control" id="width" value="150">
								</div>
							</div>
							<div class="form-group form-group-sm">
								<div class="input-group" style="width:125px">
									<div class="input-group-addon">Height</div>
									<input type="number" min="10" class="form-control" id="height" value="150">
								</div>
							</div>
							<div class="checkbox">
								<label>
									<input id="normalize" type="checkbox" checked="checked"> Normalize coords
								</label>
							</div>
						</form>
					</div>
					<div class="row">
						<div id="container" style="height:500px; margin-top:20px"></div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script src="monaco-editor/min/vs/loader.js"></script>
<script src="b64.js"></script>
<script src="LZWEncoder.js"></script>
<script src="NeuQuant.js"></script>
<script src="GIFEncoder.js"></script>
<script>
function updateCode(code){

	// Take all from ctx and put on global
	for(var key in ctx){
		(function(keyScoped){
			try {
				if(typeof ctx[keyScoped] === 'function'){
					window[keyScoped] = function(){
						return ctx[keyScoped].apply(ctx,arguments);
					};
				} else {
					Object.defineProperty(window, keyScoped, {
						get: function(){ return ctx[keyScoped]; },
						set: function(value){ ctx[keyScoped] = value; },
					});
				}
			} catch(err){
				//console.error(err)
			}
		})(key);
	}

	// Math shortcuts
	var keys = Object.getOwnPropertyNames(Math);
	for(var i=0; i<keys.length; i++){
		var key = keys[i];
		window[key] = Math[key];
	}

	eval(code);
	window.draw = draw; // Update the current one
}

(function(){
	var editor;
	var canvas = document.getElementById('bitmap');
	var ctx = window.ctx = canvas.getContext('2d');
	var inputs = {};
	var normalize = false;
	inputs.frameCount = document.getElementById('frameCount');
	inputs.delay = document.getElementById('delay');
	inputs.width = document.getElementById('width');
	inputs.height = document.getElementById('height');
	inputs.normalize = document.getElementById('normalize');

	var encoder = new GIFEncoder();

	function makeGif(){
		update();

		var frame = 0;
		var frameCount = parseInt(inputs.frameCount.value, 10);
		var delay = parseInt(inputs.delay.value, 10);
		var width = parseInt(inputs.width.value, 10);
		var height = parseInt(inputs.height.value, 10);
		var normalize = inputs.normalize.checked;

		var canvas = document.createElement('canvas');
		canvas.width = width;
		canvas.height = height;
		var ctx = window.ctx = canvas.getContext('2d');

		encoder.setRepeat(0); //auto-loop
		encoder.setDelay(delay);
		encoder.setSize(width,height);
		encoder.start();

		if(normalize){
			ctx.scale(width,height);
		}

		for(var i=0;i<frameCount; i++){
			console.log('Adding frame ' + frame + '...');

			ctx.save();
			ctx.fillStyle = "rgb(255,255,255)";
			if(normalize)
				ctx.fillRect(0,0,1,1);
			else
				ctx.fillRect(0,0,width,height);

			try {
				window.draw(frame/frameCount);
			} catch(err){
				console.error(err);
			}

			encoder.addFrame(ctx);

			frame++;

			ctx.restore();
		}

		encoder.finish();
		//document.getElementById('image').src = 'data:image/gif;base64,'+encode64(encoder.stream().getData());
		//encoder.download();

		var save = document.createElement('a');
		save.href = 'data:image/gif;base64,'+encode64(encoder.stream().getData());
		save.download = 'codegif.gif';
		var event = document.createEvent("MouseEvents");
		event.initMouseEvent(
			"click", true, false, window, 0, 0, 0, 0, 0
			, false, false, false, false, 0, null
		);
		save.dispatchEvent(event);
	}

	// Init editor
	require.config({ paths: { 'vs': 'monaco-editor/min/vs' }});
	require(['vs/editor/editor.main'], function() {
		editor = monaco.editor.create(document.getElementById('container'), {
			value: draw.toString(),
			language: 'javascript',
			theme: 'vs'
		});
		init();
	});

	function debounce(func, wait, immediate) {
		var timeout;
		return function() {
			var context = this, args = arguments;
			var later = function() {
				timeout = null;
				if (!immediate) func.apply(context, args);
			};
			var callNow = immediate && !timeout;
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
			if (callNow) func.apply(context, args);
		};
	};

	var animationLoop = null;
	function update(){

		var code = editor.getValue();
		try {
			updateCode(code);
		} catch(err){
			console.error(err);
			return;
		}

		width = parseInt(inputs.width.value, 10);
		height = parseInt(inputs.height.value, 10);

		canvas.width = canvas.getBoundingClientRect().width * window.devicePixelRatio;
		canvas.height = canvas.width * (height/width);

		delay = parseInt(inputs.delay.value, 10);
		frameCount = parseInt(inputs.frameCount.value, 10);
		if(animationLoop!==null){
			clearInterval(animationLoop);
		}
		animationLoop = setInterval(updateAnimationCanvas, delay);

		// Save
		try {
			localStorage.setItem('save', code);
		}catch(err){}
	}

	var animationFrame = 0;
	function updateAnimationCanvas(){
		window.ctx = canvas.getContext('2d');

		ctx.save();
		normalize = inputs.normalize.checked;
		if(normalize){
			ctx.scale(canvas.width,canvas.height);
		}

		ctx.fillStyle = "rgb(255,255,255)";
		if(normalize)
			ctx.fillRect(0,0,1,1);
		else
			ctx.fillRect(0,0,canvas.width,canvas.height);

		try {
			window.draw((animationFrame % frameCount) / frameCount);
		} catch(err){
			console.error(err);
		}

		ctx.restore();

		animationFrame++;
	}

	function init(){
		editor.onDidChangeModelContent(function(){
			update();
		});

		window.addEventListener('resize', function(){
			update();
			editor.layout();
		});

		for(var name in inputs){
			inputs[name].addEventListener('change', update);
			inputs[name].addEventListener('keydown', update);
			inputs[name].addEventListener('keyup', update);
		}
		document.getElementById('downloadButton').addEventListener('click', function(){
			makeGif();
		});

		var samplesList = document.getElementById('samples-list');
		var samplesElements = document.getElementsByClassName('sample');
		for(var i=0; i<samplesElements.length; i++){
			samplesList.innerHTML += '<li><a href="#">' + samplesElements[i].attributes['data-name'].value + '</a></li>';
		}
		var links = samplesList.querySelectorAll('a');
		var clickLink = function(){
			var code = document.querySelector('.sample[data-name=\'' + this.innerText + '\']').innerText;
			editor.setValue(code);
		};
		for(var i=0; i<links.length; i++){
			links[i].addEventListener('click', clickLink);
		}

		// Load saved state?
		try {
			var code = localStorage.getItem('save');
			editor.setValue(code);
		}catch(err){}

		update();
	}
})();
</script>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>

</body>
</html>