<html>
<head>
	<style>
		input[type=number] {
			width: 50px;
		}
		label {
			margin-left: 10px;
		}
	</style>
</head>
<body>
	<h1>js to gif</h1>
	<ol>
		<li>Write some HTML5 canvas code</li>
		<li>Download gif</li>
		<li>???</li>
		<li>Profit!</li>
	</ol>
	<script src="b64.js"></script>
	<script src="LZWEncoder.js"></script>
	<script src="NeuQuant.js"></script>
	<script src="GIFEncoder.js"></script>
	<canvas id="bitmap" style="display:none"></canvas>
	<img id="image"><br>

	<p>
		<input id="downloadButton" type="submit" value="Download GIF"/>

		<label>Frames</label>
		<input id="frameCount" type="number" value="30"/>

		<label>Delay</label>
		<input id="delay" type="number" min="1" value="16"/>

		<label>Width</label>
		<input id="width" type="number" min="1" value="150"/>

		<label>Height</label>
		<input id="height" type="number" min="1" value="150"/>

	</p>

	<script>
//based on: https://developer.mozilla.org/en/Canvas_tutorial/Basic_animations#An_animation_example_2
function draw(t){ // t is between 0 and 1
	save(); // equivalent to ctx.save()
	fillStyle = "rgb(255,255,255)";  // equivalent to ctx.fillStyle = ...
	fillRect(0,0,150, 150);

	translate(75,75);
	scale(0.4,0.4);
	rotate(-PI/2); // No need to use Math.PI. PI is shorter!
	strokeStyle = "black";
	fillStyle = "white";
	lineWidth = 8;
	lineCap = "round";

	// Hour marks
	save();
	for (var i=0;i<12;i++){
		beginPath();
		rotate(PI/6);
		moveTo(100,0);
		lineTo(120,0);
		stroke();
	}
	restore();

	// Minute marks
	save();
	lineWidth = 5;
	for (i=0;i<60;i++){
		if (i%5!=0) {
			beginPath();
			moveTo(117,0);
			lineTo(120,0);
			stroke();
		}
		rotate(PI/30);
	}
	restore();

	var sec = t * 60;
	var min = 0;
	var hr  = 0;
	hr = hr>=12 ? hr-12 : hr;

	fillStyle = "black";

	// write Hours
	save();
	rotate( hr*(PI/6) + (PI/360)*min + (PI/21600)*sec )
	lineWidth = 14;
	beginPath();
	moveTo(-20,0);
	lineTo(80,0);
	stroke();
	restore();

	// write Minutes
	save();
	rotate( (PI/30)*min + (PI/1800)*sec )
	lineWidth = 10;
	beginPath();
	moveTo(-28,0);
	lineTo(112,0);
	stroke();
	restore();

	// Write seconds
	save();
	rotate(sec * PI/30);
	strokeStyle = "#D40000";
	fillStyle = "#D40000";
	lineWidth = 6;
	beginPath();
	moveTo(-30,0);
	lineTo(83,0);
	stroke();
	beginPath();
	arc(0,0,10,0,PI*2,true);
	fill();
	beginPath();
	arc(95,0,10,0,PI*2,true);
	stroke();
	fillStyle = "#555";
	arc(0,0,3,0,PI*2,true);
	fill();
	restore();

	beginPath();
	lineWidth = 14;
	strokeStyle = '#325FA2';
	arc(0,0,142,0,PI*2,true);
	stroke();

	restore();

}
</script>

<div id="container" style="width:100%;height:50%;"></div>
<script src="monaco-editor/min/vs/loader.js"></script>
<script>
function evalCode(code){

	// Take all from ctx and put on global
	for(var key in ctx){
		(function(keyScoped){
			try {
				if(typeof ctx[keyScoped] === 'function'){
					window[keyScoped] = function(){
						return ctx[keyScoped].apply(ctx,arguments);
					};
				} else {
					Object.defineProperty(window, keyScoped, {
						get: function(){ return ctx[keyScoped]; },
						set: function(value){ ctx[keyScoped] = value; },
					});
				}
			} catch(err){
				//console.error(err)
			}
		})(key);
	}

	// Math shortcuts
	var keys = Object.getOwnPropertyNames(Math);
	for(var i=0; i<keys.length; i++){
		var key = keys[i];
		window[key] = Math[key];
	}

	eval(code);
	window.draw = draw; // Update the current one
}

(function(){
	var editor;
	var canvas = document.getElementById('bitmap');
	var ctx = window.ctx = canvas.getContext('2d');
	var inputs = {};
	inputs.frameCount = document.getElementById('frameCount');
	inputs.delay = document.getElementById('delay');
	inputs.width = document.getElementById('width');
	inputs.height = document.getElementById('height');

	var encoder = new GIFEncoder();

	// TODO: update gif in worker
	function updateGif(){
		var code = editor.getValue();
		try {
			evalCode(code);
		} catch(err){
			console.error(err);
			return;
		}

		var frameCount = parseInt(inputs.frameCount.value, 10);
		var delay = parseInt(inputs.delay.value, 10);
		var width = parseInt(inputs.width.value, 10);
		var height = parseInt(inputs.height.value, 10);

		encoder.setRepeat(0); //auto-loop
		encoder.setDelay(delay);
		canvas.width = width;
		canvas.height = height;
		encoder.setSize(width,height);
		encoder.start();
		ctx.fillStyle = "rgb(255,255,255)";
		ctx.fillRect(0,0,canvas.width, canvas.height); //GIF can't do transparent so do white

		for(var i = 0; i < frameCount; i++){
			window.draw(i/frameCount);
			encoder.addFrame(ctx);
		}
		encoder.finish();

		// Preview
		document.getElementById('image').src = 'data:image/gif;base64,'+encode64(encoder.stream().getData());
	}

	require.config({ paths: { 'vs': 'monaco-editor/min/vs' }});
	require(['vs/editor/editor.main'], function() {
		editor = monaco.editor.create(document.getElementById('container'), {
			value: draw.toString(),
			language: 'javascript',
			theme: 'vs-dark'
		});
		init();
	});

	function debounce(func, wait, immediate) {
		var timeout;
		return function() {
			var context = this, args = arguments;
			var later = function() {
				timeout = null;
				if (!immediate) func.apply(context, args);
			};
			var callNow = immediate && !timeout;
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
			if (callNow) func.apply(context, args);
		};
	};

	var updateGifDebounced = debounce(updateGif, 500);
	function init(){
		editor.onDidChangeModelContent(function(){
			updateGifDebounced();
		});
		updateGifDebounced();

		for(var name in inputs){
			inputs[name].addEventListener('change', updateGifDebounced);
			inputs[name].addEventListener('keydown', updateGifDebounced);
		}
		document.getElementById('downloadButton').addEventListener('click', function(){
			encoder.download();
		});
	}
})();
</script>

</body>
</html>