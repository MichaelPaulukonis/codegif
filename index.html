<html>
<head>
	<style>
	</style>
</head>
<body>
	<h1>js to gif</h1>
	<ol>
		<li>Write some HTML5 canvas code</li>
		<li>Download gif</li>
		<li>...</li>
		<li>Profit!</li>
	</ol>
	<script src="b64.js"></script>
	<script src="LZWEncoder.js"></script>
	<script src="NeuQuant.js"></script>
	<script src="GIFEncoder.js"></script>
	<canvas id="bitmap" style="display:none"></canvas>
	<img id="image"><br>

	<label>Frame Count</label>
	<input id="frameCount" type="number" value="30"/>

	<label>Delay</label>
	<input id="delay" type="number" min="1" value="16"/>

	<label>Width</label>
	<input id="width" type="number" min="1" value="150"/>

	<label>Height</label>
	<input id="height" type="number" min="1" value="150"/>

	<a href="#" onclick="javascript:encoder.download()">Download GIF</a>

	<script>
//based on: https://developer.mozilla.org/en/Canvas_tutorial/Basic_animations#An_animation_example_2
function draw(t){
	ctx.save();
	ctx.fillStyle = "rgb(255,255,255)";
	ctx.fillRect(0,0,150, 150); //GIF can't do transparent so do white

	ctx.translate(75,75);
	ctx.scale(0.4,0.4);
	ctx.rotate(-Math.PI/2);
	ctx.strokeStyle = "black";
	ctx.fillStyle = "white";
	ctx.lineWidth = 8;
	ctx.lineCap = "round";

	// Hour marks
	ctx.save();
	for (var i=0;i<12;i++){
		ctx.beginPath();
		ctx.rotate(Math.PI/6);
		ctx.moveTo(100,0);
		ctx.lineTo(120,0);
		ctx.stroke();
	}
	ctx.restore();

	// Minute marks
	ctx.save();
	ctx.lineWidth = 5;
	for (i=0;i<60;i++){
		if (i%5!=0) {
			ctx.beginPath();
			ctx.moveTo(117,0);
			ctx.lineTo(120,0);
			ctx.stroke();
		}
		ctx.rotate(Math.PI/30);
	}
	ctx.restore();

	var sec = t * 60;
	var min = 0;
	var hr  = 0;
	hr = hr>=12 ? hr-12 : hr;

	ctx.fillStyle = "black";

	// write Hours
	ctx.save();
	ctx.rotate( hr*(Math.PI/6) + (Math.PI/360)*min + (Math.PI/21600)*sec )
	ctx.lineWidth = 14;
	ctx.beginPath();
	ctx.moveTo(-20,0);
	ctx.lineTo(80,0);
	ctx.stroke();
	ctx.restore();

	// write Minutes
	ctx.save();
	ctx.rotate( (Math.PI/30)*min + (Math.PI/1800)*sec )
	ctx.lineWidth = 10;
	ctx.beginPath();
	ctx.moveTo(-28,0);
	ctx.lineTo(112,0);
	ctx.stroke();
	ctx.restore();

	// Write seconds
	ctx.save();
	ctx.rotate(sec * Math.PI/30);
	ctx.strokeStyle = "#D40000";
	ctx.fillStyle = "#D40000";
	ctx.lineWidth = 6;
	ctx.beginPath();
	ctx.moveTo(-30,0);
	ctx.lineTo(83,0);
	ctx.stroke();
	ctx.beginPath();
	ctx.arc(0,0,10,0,Math.PI*2,true);
	ctx.fill();
	ctx.beginPath();
	ctx.arc(95,0,10,0,Math.PI*2,true);
	ctx.stroke();
	ctx.fillStyle = "#555";
	ctx.arc(0,0,3,0,Math.PI*2,true);
	ctx.fill();
	ctx.restore();

	ctx.beginPath();
	ctx.lineWidth = 14;
	ctx.strokeStyle = '#325FA2';
	ctx.arc(0,0,142,0,Math.PI*2,true);
	ctx.stroke();

	ctx.restore();

}
</script>

<div id="container" style="width:100%;height:50%;"></div>
<script src="monaco-editor/min/vs/loader.js"></script>
<script>
function evalCode(code){
	eval(code);
	window.draw = draw; // Update the current one
}

(function(){
	var editor;
	var canvas = document.getElementById('bitmap');
	var ctx = window.ctx = canvas.getContext('2d');
	var inputs = {};
	inputs.frameCount = document.getElementById('frameCount');
	inputs.delay = document.getElementById('delay');
	inputs.width = document.getElementById('width');
	inputs.height = document.getElementById('height');

	var encoder = new GIFEncoder();

	// TODO: update gif in worker
	function updateGif(){
		var code = editor.getValue();
		try {
			evalCode(code);
		} catch(err){
			console.error(err);
			return;
		}

		var frameCount = parseInt(inputs.frameCount.value, 10);
		var delay = parseInt(inputs.delay.value, 10);
		var width = parseInt(inputs.width.value, 10);
		var height = parseInt(inputs.height.value, 10);

		encoder.setRepeat(0); //auto-loop
		encoder.setDelay(delay);
		canvas.width = width;
		canvas.height = height;
		encoder.setSize(width,height);
		encoder.start();
		ctx.fillStyle = "rgb(255,255,255)";
		ctx.fillRect(0,0,canvas.width, canvas.height); //GIF can't do transparent so do white

		for(var i = 0; i < frameCount; i++){
			window.draw(i/frameCount);
			encoder.addFrame(ctx);
		}
		encoder.finish();

		// Preview
		document.getElementById('image').src = 'data:image/gif;base64,'+encode64(encoder.stream().getData());
	}

	require.config({ paths: { 'vs': 'monaco-editor/min/vs' }});
	require(['vs/editor/editor.main'], function() {
		editor = monaco.editor.create(document.getElementById('container'), {
			value: draw.toString(),
			language: 'javascript',
			theme: 'vs-dark'
		});
		init();
	});

	function debounce(func, wait, immediate) {
		var timeout;
		return function() {
			var context = this, args = arguments;
			var later = function() {
				timeout = null;
				if (!immediate) func.apply(context, args);
			};
			var callNow = immediate && !timeout;
			clearTimeout(timeout);
			timeout = setTimeout(later, wait);
			if (callNow) func.apply(context, args);
		};
	};

	var updateGifDebounced = debounce(updateGif, 500);
	function init(){
		editor.onDidChangeModelContent(function(){
			updateGifDebounced();
		});
		updateGifDebounced();

		for(var name in inputs){
			inputs[name].addEventListener('change', updateGifDebounced);
			inputs[name].addEventListener('keydown', updateGifDebounced);
		}
	}
})();
</script>

</body>
</html>